### Задание 4. Логирование

##### Список необходимых логов:
1. INFO:
    - изменение статуса заказа — время, предыдущий статус заказа, текущий статус заказа, номер заказа
    - данные расчета стоимости изготовления изделия — идентификатор заказа, длительность изготовления, время когда расчет закончен, параметры расчета, идентификатор пользователя
    - создание заказа через API: время создания, идентификатор пользователя, модель изделия
2. WARNING:
    - неудачная попытка отправить событие в очередь(+ повторные попытки) - идентификатор заказа, тип события, время отправки, ошибка отправки, номер попытки
    - в API создания заказа переданы невалидные данные - идентификатор пользователя, входящие данные(перс данные маскируем), ошибка валидации
3. ERROR:
    - все ошибки API сервера (5xx) - идентификатор заказа идентификатор пользователя, ошибка сервера, входные данные(перс данные маскируем) в метод API
    - dead-letter сообщения в очереди - время возникновения события, идентификатор заказа, тип сообщения, причина-ошибка по которой сообщение не может обработаться
    - расчет стоимости завершился с ошибкой - время возникновения ошибки, текст ошибки, идентификатор заказа, идентификатор пользователя

##### Мотивация:
1. ускорение процесса диагностики ошибок, логи помогают быстро локализовать и устранить причины сбоев
2. логирование WARNING-событий помогает выявить потенциальные проблемы в логике кода
3. повышение качества и скорости разработки, логи предоставляют данные для анализа типичных ошибок и их частоты
4. при дебаге какой-то проблемы, логи дополняют информацию, которую мы получаем с помощью трейсинга

###### Технические и бизнес-метрики:
- количество пропущенных/необработанных сообщений — теперь можно оперативно найти сбой, восстановить сообщения
- время реакции поддержки — снижается из-за доступности логов
- скорость обнаружения аномалий — логирование совместно с мониторингом помогает быстро выявлять всплески неуспешных операций

##### Приоритеты для систем логирования и трейсинга:
1. MES API — большое кол-во жалоб связанных с производством и задержками
2. CRM API — очень важно для управления заказами и их статусами, там часто возникают конфликты или потеря сообщений
3. RabbitMQ — центральный механизм для передачи событий между CRM и MES, любые сбои в очереди очень сильно влияют на выполнение заказов

##### Предлагаемое решение:
Для логов удобнее всего использовать стек ELK(ElasticSearch + Kibana + Logstash) + Filebeat как агент для сборки и нормализации логов от микросервисов, диаграмма: [jewerly_c4_model_task4.drawio](jewerly_c4_model_task4.drawio)

##### Политика безопасности:
1. доступ к Kibana должен быть ограничен внутренней сетью(VPN)
2. внедрение аутентификации — зайти в Kibana смогут только сотрудники компании с актуальной учетной записью и ролью DevOps/Поддержка/Developer/QA
3. связь между микросервисами и Filebeat лучше поднять поверх TLS, чтобы не передавать логи в незашифрованном виде
4. в логах не должны передаваться перс данные пользователей, либо они должны быть замаскированны

##### Политика хранения:
1. используем отдельные индексы для отдельных критически важных микросервисов(MES API, CRM API, RabbitMQ)
2. для менее важных микросервисов можно использовать один индекс
3. максимальный размер индекса ограничим 10Гб, при достижении 10Гб за счет процесса ролловера будет создаваться новый индекс, старый индекс будет использоваться только для чтения
4. индексы старше полугода будут автоматически удаляться, либо если потребуется хранить логи дольше(например для каких-то расследований инцидентов), то старые индексы можно переносить в холодное хранилище

##### Необходимые мероприятия для превращения системы сбора логов в систему анализа логов:

###### Алертинг:
- настройка правил, которые срабатывают при аномалиях(например, резкий рост ошибок уровень ERROR, или резкий рост RPS)
- в ELK есть Watcher
- уведомления в email, telegram, sms

###### Поиск аномалий:
- было четыре записи о создании заказов и за секунду их стало 10 000. Возможно, происходит DDoS-атака конкурентами
- Elastic Machine Learning может предупреждать о подозрительной активности