### Задание 2. Мониторинг

##### Мотивация:
1. для бизнеса:
    - снижение потерь: быстрое обнаружение сбоев → меньше отменённых заказов → сохранение клиентов и заказов
    - прозрачность: видимость статусов заказов в реальном времени → оперативное информирование клиентов
    - планирование: анализ нагрузки на MES → прогнозирование масштабирования
2. для разработки:
    - быстрая диагностика: поиск корневых причин ошибок(например, зависание RabbitMQ)
    - проактивное устранение проблем: алерты до того, как клиенты начнут жаловаться

##### Выбор подхода к мониторингу:
1. для API и бизнес-процессов — RED (Rate, Errors, Duration):
    - отслеживать пользовательские сценарии(например, создание заказа через API)
2. для инфраструктуры(БД, серверы) — USE (Utilization, Saturation, Errors):
    - поможет выявить перегрузку CPU/памяти или дисков
3. для интеграций(RabbitMQ) — "четыре золотых сигнала":
    - traffic(количество сообщений), latency(время обработки), errors(недоставленные сообщения), saturation(размер очереди)

##### Метрики:
1. shop API:
   1. метрики нагрузки:
      - Number of requests (RPS) for internet shop API: ярлыки(тип метода, название метода, название ДЦ)
      - Response time (latency) for shop API: ярлыки(тип метода, название метода, название ДЦ)
      - Number of HTTP 200 for shop API: ярлыки(тип метода, название метода, название ДЦ) - метрика успешных ответов
      - Number of HTTP 5XX for shop API: ярлыки(тип метода, название метода, название ДЦ) - отдельная метрика для 5xx ошибок, чтобы оперативно отслеживать ошибки сервера
      - Number of HTTP 4XX for shop API: ярлыки(тип метода, название метода, название ДЦ) - метрика с кодами бизнесовых ошибок (например, 400)
   2. инфраструктурные метрики:
      - CPU % for shop API: ярлыки(название сервиса)
      - Memory utilization for shop API: ярлыки(название сервиса)
      - Size of shop db instance: ярлыки(url мастера/реплик)
      - Kb transferred (received) and Kb provided (sent) for shop API: ярлыки(название сервиса, тип received/sent)

2. CRM API:
   1. бизнесовые метрики:
      - Orders count - ярлыки(источник: shop или mes), кол-во заказов, которое создается в системе
      - Orders count per user - ярлыки(источник: shop или mes, id пользователя), кол-во заказов в разрезе пользователей
      - Orders completed count -  ярлыки(источник: shop или mes), кол-во завершенных заказов
      - Orders complete SLA - задержки в выполнении заказов относительно обещанного пользователю срока
   2. метрики нагрузки:
      - Queue consume error rate - ярлыки(тип очереди), rate ошибок на получение сообщений из очереди
      - Queue produce error rate - ярлыки(тип очереди), rate ошибок на публикацию сообщений в очереди, которые публикуются для обработки в MES
      - Queue length - ярлыки(тип очереди), длина очереди
      - Number of requests (RPS) for CRM API: ярлыки(тип метода, название метода, название ДЦ)
      - Response time (latency) for CRM API: ярлыки(тип метода, название метода, название ДЦ)
      - Number of HTTP 200 for CRM API: ярлыки(тип метода, название метода, название ДЦ) - метрика успешных ответов
      - Number of HTTP 5xx for CRM API: ярлыки(тип метода, название метода, название ДЦ) - отдельная метрика для 5xx ошибок, чтобы оперативно отслеживать ошибки сервера
      - Number of HTTP 4xx for CRM API: ярлыки(тип метода, название метода, название ДЦ) - метрика с кодами бизнесовых ошибок (например, 400)
   3. инфраструктурные метрики:
      - CPU % for CRM API: ярлыки(название сервиса)
      - Memory utilization for CRM API: ярлыки(название сервиса)
      - Kb transferred (received) and Kb provided (sent) for CRM API: ярлыки(название сервиса, тип received/sent)

3. MES API:
   1. бизнесовые метрики:
      - Orders create time - среднее время изготовления изделия
      - Orders search time - время поиска новых изделий, готовых для начала изготовления
      - Orders create time per item type - время изготовления в разрезе каждого типа изделия
   2. метрики нагрузки:
      - Queue consume error rate - ярлыки(тип очереди), rate ошибок на получение сообщений из очереди
      - Queue produce error rate - ярлыки(тип очереди), rate ошибок на публикацию сообщений в очереди, которые публикуются для обработки в MES
      - Queue length - ярлыки(тип очереди), длина очереди
      - Number of requests (RPS) for MES API или RPM: ярлыки(тип метода, название метода, название ДЦ)
      - Response time (latency) for MES API: ярлыки(тип метода, название метода, название ДЦ)
      - Number of HTTP 200 for MES API: ярлыки(тип метода, название метода, название ДЦ) - метрика успешных ответов
      - Number of HTTP 5xx for MES API: ярлыки(тип метода, название метода, название ДЦ) - отдельная метрика для 5xx ошибок, чтобы оперативно отслеживать ошибки сервера
      - Number of HTTP 4xx for MES API: ярлыки(тип метода, название метода, название ДЦ) - метрика с кодами бизнесовых ошибок (например, 400)
   3. инфраструктурные метрики:
      - CPU % for MES API: ярлыки(название сервиса)
      - Memory utilization for MES API: ярлыки(название сервиса)
      - Size of MES db instance: ярлыки(url мастера/реплик)
      - Kb transferred (received) and Kb provided (sent) for MES API: ярлыки(название сервиса, тип received/sent)

4. RabbitMQ:
    - Number of dead-letter-exchange letters in RabbitMQ: ярлыки (тип очереди, причина попадания в DLX), сигнализирует о проблемах с обработкой сообщений в очереди
    - Number of messages in flight in RabbitMQ: ярлыки(тип очереди), метрика позволит отслеживает как активно используются очереди

##### План действий:
1. разворачиваем Prometheus с time-series базой для хранения значений метрик
2. прописать в конфиги(`scrape_configs`) Prometheus адреса всех микросервисов, с которых будут приходить метрики
3. добавляем во все сервисы клиентскую библиотеку, и используем её чтобы писать через неё метрики
4. разворачиваем Grafana
5. добавляем Prometheus соединение, указываем адрес Prometheus сервера
6. создаём отдельные дашборды для каждого микросервиса, и добавляем панели с метриками, в которых будут рисоваться графики
7. навешиваем алерты на самые важные метрики